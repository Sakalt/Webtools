<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„Ç™„É≥„É©„Ç§„É≥RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Yomogi', sans-serif;
        }
        #gameCanvas {
            display: block;
            background-color: #e0e0e0;
        }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 100px;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            touch-action: none;
        }
        #joystickInner {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            top: 25px;
            left: 25px;
        }
        #inventory {
            position: absolute;
            bottom: 140px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        .item {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: #ccc;
            border: 1px solid #333;
            margin: 5px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
        }
        #chat {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 300px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #chatMessages {
            height: 100px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        #chatInput {
            width: calc(100% - 22px);
        }
        #leaderboard {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #leaderboard ol {
            padding-left: 20px;
        }
        .npc {
            color: green;
        }
        .sign {
            color: brown;
        }
        .hp-bar {
            position: absolute;
            width: 100px;
            height: 10px;
            background-color: red;
        }
        .mp-bar {
            position: absolute;
            width: 100px;
            height: 10px;
            background-color: blue;
            top: 12px;
        }
        #battleScreen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
        #dialog {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="joystick">
        <div id="joystickInner"></div>
    </div>
    <div id="inventory">
        <div class="item" onclick="useItem('sword')">‚öîÔ∏è</div>
        <div class="item" onclick="useItem('shield')">üõ°Ô∏è</div>
        <div class="item" onclick="useItem('wood')">üå≥</div>
        <div class="item" onclick="castSpell('feuer')">üî•</div>
        <div class="item" onclick="castSpell('isen')">‚ùÑÔ∏è</div>
        <div class="item" onclick="castSpell('grass')">üåø</div>
        <div class="item" onclick="useItem('mpPotion')">üß™</div>
        <div class="item" onclick="castSpell('lightningBuster')">‚ö°</div>
    </div>
    <div id="chat">
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" onkeydown="if(event.key === 'Enter') sendMessage()">
    </div>
    <div id="leaderboard">
        <h3>„É©„É≥„Ç≠„É≥„Ç∞</h3>
        <ol id="leaderboardList"></ol>
    </div>
    <div id="battleScreen">
        <h2>Êà¶Èóò‰∏≠</h2>
        <div id="battleLog"></div>
        <button onclick="attack()">ÊîªÊíÉ</button>
        <button onclick="useItem('mpPotion')">MPÂõûÂæ©</button>
    </div>
    <div id="dialog">
        <div id="dialogContent"></div>
        <button onclick="closeDialog()">Èñâ„Åò„Çã</button>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const joystick = document.getElementById('joystick');
        const joystickInner = document.getElementById('joystickInner');
        const battleScreen = document.getElementById('battleScreen');
        const battleLog = document.getElementById('battleLog');
        const dialog = document.getElementById('dialog');
        const dialogContent = document.getElementById('dialogContent');
        const players = {};
        const enemies = [{ id: 'enemy1', x: 100, y: 100, hp: 20, damage: 3, lv: 1 }, { id: 'enemy2', x: 150, y: 150, hp: 30, damage: 5, lv: 2 }];
        const merchants = [{ id: 'merchant1', x: 200, y: 200 }];
        const trees = [{ id: 'tree1', x: 300, y: 300 }];
        const npcs = [{ id: 'npc1', x: 350, y: 350, text: 'ŸÖÿ±ÿ≠ÿ®ÿß!'}];
        const signs = [{ id: 'sign1', x: 400, y: 400, text: '‚ö°„Åì„Åì„ÅßÊúÄÂº∑È≠îÊ≥ï„Äå„É©„Ç§„Éà„Éã„É≥„Ç∞„Éê„Çπ„Çø„Éº„Äç„ÇíÂèñÂæó„Åß„Åç„Åæ„Åô‚ö°'}];
        const shopItems = { sword: 14, shield: 12, mpPotion: 5 };
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const leaderboardList = document.getElementById('leaderboardList');
        const lightningBusterCost = 400;
        const battle = { active: false, enemy: null, playerTurn: true };

        let playerId = Math.random().toString(36).substring(2);
        let x = Math.random() * window.innerWidth;
        let y = Math.random() * window.innerHeight;
        let hp = 30;
        let mp = 20;
        let gold = 0;
        let level = 1;
        let exp = 0;
        let spells = { feuer: 5, isen: 7, grass: 6, lightningBuster: 10 };
        let inventory = { sword: true, shield: false, wood: false, mpPotion: 1, lightningBuster: false };
        let touchStartX, touchStartY, touchCurrentX, touchCurrentY;
        let moving = false;
        let weather = 'Êô¥„Çå';

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const socket = new WebSocket('ws://localhost:8080');

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                for (const id in data.players) {
                    if (id !== playerId) {
                        players[id] = data.players[id];
                    }
                }
                updateLeaderboard(data.leaderboard);
            } else if (data.type === 'chat') {
                addChatMessage(data.message);
            }
        };

        function drawPlayer(x, y) {
            ctx.fillStyle = 'blue';
            ctx.fillRect(x, y, 20, 20);
            drawHpBar(x, y, hp);
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.fillStyle = 'red';
                ctx.fillRect(enemy.x, enemy.y, 20, 20);
                drawHpBar(enemy.x, enemy.y, enemy.hp);
            });
        }

        function drawMerchants() {
            merchants.forEach(merchant => {
                ctx.fillStyle = 'purple';
                ctx.fillRect(merchant.x, merchant.y, 20, 20);
            });
        }

        function drawTrees() {
            trees.forEach(tree => {
                ctx.fillStyle = 'green';
                ctx.fillRect(tree.x, tree.y, 20, 20);
            });
        }

        function drawNpcs() {
            npcs.forEach(npc => {
                ctx.fillStyle = 'yellow';
                ctx.fillRect(npc.x, npc.y, 20, 20);
                if (npc === players[playerId]) {
                    ctx.fillText(npc.text, npc.x + 25, npc.y + 10);
                }
            });
        }

        function drawSigns() {
            signs.forEach(sign => {
                ctx.fillStyle = 'brown';
                ctx.fillRect(sign.x, sign.y, 20, 20);
                ctx.fillText(sign.text, sign.x + 25, sign.y + 10);
            });
        }

        function drawHpBar(x, y, hp) {
            ctx.fillStyle = 'red';
            ctx.fillRect(x, y - 10, 100, 10);
            ctx.fillStyle = 'green';
            ctx.fillRect(x, y - 10, hp, 10);
        }

        function updateLeaderboard(leaderboard) {
            leaderboardList.innerHTML = '';
            leaderboard.forEach(player => {
                const listItem = document.createElement('li');
                listItem.textContent = `${player.name}: ${player.score}`;
                leaderboardList.appendChild(listItem);
            });
        }

        function addChatMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value;
            if (message.trim()) {
                socket.send(JSON.stringify({ type: 'chat', message: message }));
                chatInput.value = '';
            }
        }

        function useItem(item) {
            if (inventory[item]) {
                if (item === 'mpPotion') {
                    mp += 10;
                    if (mp > 20) mp = 20;
                }
                if (item === 'sword') {
                    // sword usage logic
                }
                if (item === 'shield') {
                    // shield usage logic
                }
                if (item === 'lightningBuster') {
                    // lightningBuster usage logic
                }
            }
        }

        function castSpell(spell) {
            if (mp >= spells[spell]) {
                mp -= spells[spell];
                if (spell === 'feuer') {
                    // fire spell logic
                }
                if (spell === 'isen') {
                    // ice spell logic
                }
                if (spell === 'grass') {
                    // grass spell logic
                }
                if (spell === 'lightningBuster') {
                    // lightningBuster spell logic
                    if (gold >= lightningBusterCost) {
                        gold -= lightningBusterCost;
                        inventory.lightningBuster = true;
                    } else {
                        addChatMessage('„Ç¥„Éº„É´„Éâ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ');
                    }
                }
            } else {
                addChatMessage('MP„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ');
            }
        }

        function attack() {
            if (battle.active && battle.playerTurn) {
                if (battle.enemy) {
                    battle.enemy.hp -= 10;
                    battleLog.innerHTML += `<p>„ÅÇ„Å™„Åü„ÅØÊïµ„Å´ÊîªÊíÉ„Åó„Åæ„Åó„Åü„ÄÇÊïµ„ÅÆHP: ${battle.enemy.hp}</p>`;
                    if (battle.enemy.hp <= 0) {
                        battleLog.innerHTML += '<p>Êïµ„ÇíÂÄí„Åó„Åæ„Åó„ÅüÔºÅ</p>';
                        battle.active = false;
                        battle.enemy = null;
                        battleScreen.style.display = 'none';
                    } else {
                        battle.playerTurn = false;
                        setTimeout(() => {
                            if (battle.enemy) {
                                hp -= battle.enemy.damage;
                                battleLog.innerHTML += `<p>Êïµ„ÅåÊîªÊíÉ„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Å™„Åü„ÅÆHP: ${hp}</p>`;
                                if (hp <= 0) {
                                    battleLog.innerHTML += '<p>„ÅÇ„Å™„Åü„ÅØÂÄí„Çå„Åæ„Åó„Åü...</p>';
                                    battle.active = false;
                                    battleScreen.style.display = 'none';
                                }
                                battle.playerTurn = true;
                            }
                        }, 1000);
                    }
                }
            }
        }

        function openDialog(message) {
            dialogContent.textContent = message;
            dialog.style.display = 'block';
        }

        function closeDialog() {
            dialog.style.display = 'none';
        }

        function handleTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        }

        function handleTouchMove(event) {
            touchCurrentX = event.touches[0].clientX;
            touchCurrentY = event.touches[0].clientY;
            if (Math.abs(touchCurrentX - touchStartX) > 10 || Math.abs(touchCurrentY - touchStartY) > 10) {
                moving = true;
                joystickInner.style.left = `${touchCurrentX - joystick.offsetLeft - 25}px`;
                joystickInner.style.top = `${touchCurrentY - joystick.offsetTop - 25}px`;
                x += (touchCurrentX - touchStartX) / 10;
                y += (touchCurrentY - touchStartY) / 10;
                touchStartX = touchCurrentX;
                touchStartY = touchCurrentY;
            }
        }

        function handleTouchEnd(event) {
            moving = false;
            joystickInner.style.left = '25px';
            joystickInner.style.top = '25px';
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPlayer(x, y);
            drawEnemies();
            drawMerchants();
            drawTrees();
            drawNpcs();
            drawSigns();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        joystick.addEventListener('touchstart', handleTouchStart);
        joystick.addEventListener('touchmove', handleTouchMove);
        joystick.addEventListener('touchend', handleTouchEnd);

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
