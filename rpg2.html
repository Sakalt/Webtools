<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„Ç™„É≥„É©„Ç§„É≥RPG</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #gameCanvas { display: block; background-color: #e0e0e0; }
        #joystick { position: absolute; bottom: 20px; left: 20px; width: 100px; height: 100px; background-color: rgba(0, 0, 0, 0.3); border-radius: 50%; touch-action: none; }
        #joystickInner { position: absolute; width: 50px; height: 50px; background-color: rgba(0, 0, 0, 0.5); border-radius: 50%; top: 25px; left: 25px; }
        #inventory { position: absolute; bottom: 140px; left: 20px; background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; }
        .item { display: inline-block; width: 40px; height: 40px; background-color: #ccc; border: 1px solid #333; margin: 5px; text-align: center; line-height: 40px; cursor: pointer; }
        #chat { position: absolute; bottom: 10px; right: 10px; width: 300px; background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; }
        #chatMessages { height: 100px; overflow-y: scroll; margin-bottom: 10px; }
        #chatInput { width: calc(100% - 22px); }
        #leaderboard { position: absolute; top: 10px; right: 10px; background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; }
        #leaderboard ol { padding-left: 20px; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="joystick">
        <div id="joystickInner"></div>
    </div>
    <div id="inventory">
        <div class="item" onclick="useItem('sword')">‚öîÔ∏è</div>
        <div class="item" onclick="useItem('shield')">üõ°Ô∏è</div>
        <div class="item" onclick="useItem('wood')">üå≥</div>
        <div class="item" onclick="castSpell('feuer')">üî•</div>
        <div class="item" onclick="castSpell('isen')">‚ùÑÔ∏è</div>
        <div class="item" onclick="castSpell('grass')">üåø</div>
        <div class="item" onclick="useItem('mpPotion')">üß™</div>
    </div>
    <div id="chat">
        <div id="chatMessages"></div>
        <input type="text" id="chatInput" onkeydown="if(event.key === 'Enter') sendMessage()">
    </div>
    <div id="leaderboard">
        <h3>„É©„É≥„Ç≠„É≥„Ç∞</h3>
        <ol id="leaderboardList"></ol>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const joystick = document.getElementById('joystick');
        const joystickInner = document.getElementById('joystickInner');
        const players = {};
        const enemies = [{ id: 'enemy1', x: 100, y: 100, hp: 20, damage: 3, lv: 1 }, { id: 'enemy2', x: 150, y: 150, hp: 30, damage: 5, lv: 2 }];
        const merchants = [{ id: 'merchant1', x: 200, y: 200 }];
        const trees = [{ id: 'tree1', x: 300, y: 300 }];
        const shopItems = { sword: 14, shield: 12, mpPotion: 5 };
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const leaderboardList = document.getElementById('leaderboardList');

        let playerId = Math.random().toString(36).substring(2);
        let x = Math.random() * window.innerWidth;
        let y = Math.random() * window.innerHeight;
        let hp = 30;
        let mp = 20;
        let gold = 0;
        let level = 1;
        let exp = 0;
        let spells = { feuer: 5, isen: 7, grass: 6 };
        let inventory = { sword: true, shield: false, wood: false, mpPotion: 1 };
        let touchStartX, touchStartY, touchCurrentX, touchCurrentY;
        let moving = false;
        let weather = 'Êô¥„Çå';

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const socket = new WebSocket('ws://localhost:8080');

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                for (const id in data.players) {
                    if (id !== playerId) {
                        players[id] = data.players[id];
                    }
                }
                updateLeaderboard(data.leaderboard);
            } else if (data.type === 'chat') {
                addChatMessage(data.message);
            }
        };

        function drawPlayer(x, y) {
            ctx.fillStyle = 'blue';
            ctx.fillRect(x, y, 20, 20);
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.fillStyle = 'red';
                ctx.fillRect(enemy.x, enemy.y, 20, 20);
            });
        }

        function drawMerchants() {
            merchants.forEach(merchant => {
                ctx.fillStyle = 'green';
                ctx.fillRect(merchant.x, merchant.y, 20, 20);
            });
        }

        function drawTrees() {
            trees.forEach(tree => {
                ctx.fillStyle = 'brown';
                ctx.fillRect(tree.x, tree.y, 20, 20);
            });
        }

        function updateGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawPlayer(x, y);
            drawEnemies();
            drawMerchants();
            drawTrees();
            for (const id in players) {
                const player = players[id];
                ctx.fillStyle = 'red';
                ctx.fillRect(player.x, player.y, 20, 20);
            }
            checkCollisions();
            updateWeather();
        }

        function checkCollisions() {
            enemies.forEach(enemy => {
                const distance = Math.sqrt((enemy.x - x) ** 2 + (enemy.y - y) ** 2);
                if (distance < 25) {
                    hp -= enemy.damage; // Êïµ„Åå„Éó„É¨„Ç§„É§„Éº„ÇíÊîªÊíÉ
                    if (hp <= 0) {
                        alert('„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº');
                        hp = 30;
                        x = Math.random() * window.innerWidth;
                        y = Math.random() * window.innerHeight;
                    }
                }
            });
        }

        function handleTouchStart(event) {
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
            moving = true;
        }

        function handleTouchMove(event) {
            if (!moving) return;

            touchCurrentX = event.touches[0].clientX;
            touchCurrentY = event.touches[0].clientY;

            const deltaX = touchCurrentX - touchStartX;
            const deltaY = touchCurrentY - touchStartY;

            x += deltaX * 0.1;
            y += deltaY * 0.1;

            touchStartX = touchCurrentX;
            touchStartY = touchCurrentY;

            sendPlayerData();
        }

        function handleTouchEnd(event) {
            moving = false;
        }

        function sendPlayerData() {
            const data = {
                type: 'update',
                id: playerId,
                x: x,
                y: y,
                hp: hp,
                mp: mp,
                gold: gold,
                level: level,
                exp: exp,
                inventory: inventory,
                weather: weather
            };
            socket.send(JSON.stringify(data));
        }

        function useItem(item) {
            if (item === 'mpPotion' && inventory.mpPotion > 0) {
                mp += 10; // MP„ÇíÂõûÂæ©
                inventory.mpPotion--;
                sendPlayerData();
            }
        }

        function castSpell(spell) {
            if (mp >= spells[spell]) {
                mp -= spells[spell]; // MP„ÇíÊ∂àË≤ª
                enemies.forEach(enemy => {
                    const distance = Math.sqrt((enemy.x - x) ** 2 + (enemy.y - y) ** 2);
                    if (distance < 100) {
                        if (spell === 'feuer') {
                            enemy.hp -= 10; // ÁÅ´„ÅÆÂë™Êñá„ÉÄ„É°„Éº„Ç∏
                        } else if (spell === 'isen') {
                            enemy.hp -= 7; // Ê∞∑„ÅÆÂë™Êñá„ÉÄ„É°„Éº„Ç∏
                            enemy.speed = 0.5; // Êïµ„ÇíÈÅÖ„Åè„Åô„ÇãÂäπÊûú
                        } else if (spell === 'grass') {
                            enemy.hp -= 8; // Ëçâ„ÅÆÂë™Êñá„ÉÄ„É°„Éº„Ç∏
                            enemy.poisoned = true; // Êïµ„ÇíÊØíÁä∂ÊÖã„Å´„Åô„ÇãÂäπÊûú
                        }
                        if (enemy.hp <= 0) {
                            gold += 5; // Êïµ„ÇíÂÄí„Åô„Å®„Ç≥„Ç§„É≥„Çí„Éâ„É≠„ÉÉ„Éó
                            exp += 10; // ÁµåÈ®ìÂÄ§„ÇíÁç≤Âæó
                            const index = enemies.indexOf(enemy);
                            enemies.splice(index, 1);
                            checkLevelUp();
                        }
                    }
                });
                sendPlayerData();
            } else {
                alert('MP„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
        }

        function checkLevelUp() {
            const levelUpExp = level * 50;
            if (exp >= levelUpExp) {
                level++;
                exp -= levelUpExp;
                hp += 10; // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÅßHP„ÇíÂõûÂæ©
                alert('„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„Åü!');
                sendPlayerData();
            }
        }

        function addChatMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value;
            const data = {
                type: 'chat',
                message: playerId + ': ' + message
            };
            socket.send(JSON.stringify(data));
            chatInput.value = '';
        }

        function buyItem(item) {
            if (gold >= shopItems[item]) {
                gold -= shopItems[item];
                inventory[item] = true;
                alert(item + ' „ÇíË≥ºÂÖ•„Åó„Åæ„Åó„Åü!');
                sendPlayerData();
            } else {
                alert('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
        }

        function craftItem() {
            if (inventory.wood && inventory.sword) {
                inventory.sword = false;
                inventory.wood = false;
                inventory.shield = true;
                alert('Êú®Êùê„Å®Ââ£„Çí‰Ωø„Å£„Å¶Áõæ„Çí„ÇØ„É©„Éï„Éà„Åó„Åæ„Åó„Åü!');
                sendPlayerData();
            } else {
                alert('„ÇØ„É©„Éï„Éà„Å´ÂøÖË¶Å„Å™„Ç¢„Ç§„ÉÜ„É†„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
        }

        function updateWeather() {
            const time = new Date().getHours();
            if (time >= 6 && time < 18) {
                weather = 'Êô¥„Çå';
            } else {
                weather = 'Â§ú';
            }
            ctx.fillStyle = weather === 'Êô¥„Çå' ? 'rgba(255, 255, 0, 0.1)' : 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function saveGame() {
            localStorage.setItem('playerData', JSON.stringify({
                x: x,
                y: y,
                hp: hp,
                mp: mp,
                gold: gold,
                level: level,
                exp: exp,
                inventory: inventory,
                spells: spells
            }));
        }

        function loadGame() {
            const data = JSON.parse(localStorage.getItem('playerData'));
            if (data) {
                x = data.x;
                y = data.y;
                hp = data.hp;
                mp = data.mp;
                gold = data.gold;
                level = data.level;
                exp = data.exp;
                inventory = data.inventory;
                spells = data.spells;
            }
        }

        function updateLeaderboard(leaderboard) {
            leaderboardList.innerHTML = '';
            leaderboard.forEach(player => {
                const listItem = document.createElement('li');
                listItem.textContent = `${player.name} - „É¨„Éô„É´: ${player.level}, „Ç¥„Éº„É´„Éâ: ${player.gold}`;
                leaderboardList.appendChild(listItem);
            });
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowUp') y -= 5;
            if (event.key === 'ArrowDown') y += 5;
            if (event.key === 'ArrowLeft') x -= 5;
            if (event.key === 'ArrowRight') x += 5;
            sendPlayerData();
        });

        joystick.addEventListener('touchstart', handleTouchStart);
        joystick.addEventListener('touchmove', handleTouchMove);
        joystick.addEventListener('touchend', handleTouchEnd);

        setInterval(updateGame, 1000 / 60);

        loadGame();

        window.addEventListener('beforeunload', saveGame);
    </script>
</body>
</html>
